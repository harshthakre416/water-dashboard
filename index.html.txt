<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale-1.0">
<title>Dynamic Water Quality Dashboard</title>
<!-- ECharts library -->
<script src="https://cdn.jsdelivr.net/npm/echarts@5"></script>
<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- Google Fonts (Inter) -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
  /* ECharts container ko default height */
  .chart-box {
    width: 100%; 
    height: 400px; 
    margin-bottom: 20px;
  }
  /* Table input fields ko clean look */
  input {
    border: none;
    background: transparent;
    width: 100%;
    padding: 10px 8px; /* Thoda spacing */
    transition: background-color 0.2s ease;
  }
  input:focus {
    background-color: #f0f9ff; /* Light blue focus */
    outline: none;
    box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    border-radius: 4px;
  }
  /* Table cells mein structured padding */
  td, th {
    padding: 4px; /* Cell padding kam kiya */
    border: 1px solid #e2e8f0; /* light gray border */
    text-align: left;
  }
  th {
    padding: 12px 8px; /* Header padding */
  }
  /* Body ke liye custom font */
  body {
    font-family: 'Inter', sans-serif;
    background-color: #f1f5f9; /* Lighter gray background */
  }
  /* Gemini Modal ke liye */
  #gemini-modal {
    transition: opacity 0.3s ease;
  }
  /* Loading spinner */
  .loader {
    border-top-color: #3498db;
    animation: spin 1s linear infinite;
  /* Add transition to table cells for smooth color change */
  td {
    transition: background-color 0.3s ease, border-color 0.3s ease;
  }
</style>

</head>
<body class="bg-gray-100">

  <!-- Sidebar (THEME) - Ab yeh responsive hai -->
  <!-- SIDEBAR REMOVED -->

  <!-- Mobile Overlay (Sidebar khulne par content ko fade karega) -->
  <!-- OVERLAY REMOVED -->

  <!-- Main Content Area (Ab yeh responsive hai) -->
  <div class="flex-1 flex flex-col overflow-hidden"> <!-- Desktop par margin add karega -->
    
    <!-- Header -->
    <header class="bg-white shadow-sm z-10">
      <div class="max-w-full mx-auto py-4 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
        
        <!-- Hamburger Menu Button (Sirf mobile par dikhega) -->
        <!-- HAMBURGER BUTTON REMOVED -->

        <h1 class="text-xl sm:text-2xl font-semibold text-gray-900">
          Dashboard Overview
        </h1>
        <div class="flex gap-2 sm:gap-4">
          <button onclick="generateCharts()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-3 sm:px-6 rounded-lg shadow-lg transition duration-300 ease-in-out transform hover:scale-105 text-sm sm:text-base">
            ðŸ“Š Generate
          </button>
          <!-- ==== GEMINI API BUTTON ==== -->
          <button onclick="analyzeData()" class="bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white font-bold py-2 px-3 sm:px-6 rounded-lg shadow-lg transition duration-300 ease-in-out transform hover:scale-105 text-sm sm:text-base">
            âœ¨ AI Suggestions
          </button>
        </div>
      </div>
    </header>

    <!-- Scrollable Main Content -->
    <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-4 sm:p-6">
      
      <!-- ==== NEW: KEY METRICS CARDS ==== -->
      <div class="mb-8">
        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Key Metrics</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
          
          <!-- Card 1: Total Samples (Informational Blue) -->
          <div class="bg-blue-50 border border-blue-200 p-6 rounded-lg shadow-lg flex items-center justify-between">
            <div>
              <p class="text-sm font-medium text-blue-700">Total Samples</p>
              <p id="stat-total-samples" class="text-3xl font-bold text-blue-900">0</p>
            </div>
            <div class="bg-blue-200 text-blue-700 p-3 rounded-full">
              <!-- Icon for samples -->
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            </div>
          </div>
          
          <!-- Card 2: Unsafe Turbidity (Danger Red) -->
          <div class="bg-red-100 border border-red-300 p-6 rounded-lg shadow-lg flex items-center justify-between">
            <div>
              <p class="text-sm font-medium text-red-700">Unsafe Locations</p>
              <p id="stat-unsafe" class="text-3xl font-bold text-red-900">0</p>
            </div>
            <div class="bg-red-200 text-red-700 p-3 rounded-full">
              <!-- Icon for warning/unsafe -->
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.876c1.035 0 1.848-.932 1.572-1.916L19.5 10.084c-.276-1.033-1.277-1.732-2.348-1.732h-1.304c-.381 0-.74-.158-1.012-.43l-1.63-1.63C12.83 6.095 12.42 6 12 6s-.83.095-1.206.322l-1.63 1.63c-.272.272-.63.43-1.012.43H6.848c-1.07 0-2.072.699-2.348 1.732L2.072 17.084C1.796 18.068 2.61 19 3.646 19z"></path></svg>
            </div>
          </div>

          <!-- Card 3: Poor DO (Warning Yellow) -->
          <div class="bg-yellow-100 border border-yellow-300 p-6 rounded-lg shadow-lg flex items-center justify-between">
            <div>
              <p class="text-sm font-medium text-yellow-700">Poor DO Locations</p>
              <p id="stat-poor-do" class="text-3xl font-bold text-yellow-900">0</p>
            </div>
            <div class="bg-yellow-200 text-yellow-700 p-3 rounded-full">
              <!-- Icon for poor health/DO -->
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.43c-.428 1.432-1.07 2.788-1.928 3.99A9.01 9.01 0 0112 21c-1.93 0-3.728-.6-5.14-1.66A9.03 9.03 0 014.57 15.43M5.1 10.57C6.17 9.5 7.44 8.7 9 8.25c.313-.093.63-.16.95-.22C10.63 8 11.31 8 12 8s1.37.03 2.05.08c.32.06.637.127.95.22 1.56.45 2.83 1.25 3.9 2.32"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v5"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.636 5.636l3.536 3.536M14.828 9.172l3.536-3.536"></path></svg>
            </div>
          </div>

          <!-- Card 4: Good Locations (Healthy Green) -->
          <div class="bg-green-100 border border-green-300 p-6 rounded-lg shadow-lg flex items-center justify-between">
            <div>
              <p class="text-sm font-medium text-green-700">Healthy Locations</p>
              <p id="stat-good" class="text-3xl font-bold text-green-900">0</p>
            </div>
            <div class="bg-green-200 text-green-700 p-3 rounded-full">
              <!-- Icon for healthy/good -->
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764c.548 0 .974.487.908 1.028l-1.7 8a.998.998 0 01-1.028.972H10M6 18H3.236c-.548 0-.974-.487-.908-1.028l1.7-8A.998.998 0 015.056 8H10m0 10V4m0 0l-3 3m3-3l3 3"></path></svg>
            </div>
          </div>

        </div>
      </div>
      
      <!-- Data Entry Section -->
      <div class="bg-white p-4 sm:p-6 rounded-lg shadow-lg mb-8">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
            <div>
                <h2 class="text-2xl font-semibold text-gray-800">Master Data Entry</h2>
                <p class="text-gray-600">Ek hi jagah saara data enter karein.</p>
            </div>
            <button id="addRowBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out w-full sm:w-auto">
                + Add Sample
            </button>
        </div>
        
        <div class="overflow-x-auto rounded-lg border">
            <table id="masterTable" class="w-full min-w-max">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="p-3 text-sm font-semibold text-gray-600">Date</th>
                        <th class="p-3 text-sm font-semibold text-gray-600">Location</th>
                        <th class="p-3 text-sm font-semibold text-blue-700">pH</th>
                        <th class="p-3 text-sm font-semibold text-green-700">Turbidity</th>
                        <th class="p-3 text-sm font-semibold text-purple-700">DO</th>
                    </tr>
                </thead>
                <tbody id="masterTbody" class="bg-white divide-y divide-gray-200">
                    <!-- Default sample data -->
                    <tr>
                        <td><input placeholder="2024-11-10" value="2024-11-10"></td>
                        <td><input placeholder="Tirora Lake" value="Tirora Lake"></td>
                        <td><input placeholder="7.2" value="7.2"></td>
                        <td><input placeholder="0.8" value="0.8"></td>
                        <td><input placeholder="7.5" value="7.5"></td>
                    </tr>
                    <tr>
                        <td><input placeholder="2024-11-10" value="2024-11-10"></td>
                        <td><input placeholder="School Tap" value="School Tap"></td>
                        <td><input placeholder="6.2" value="6.2"></td>
                        <td><input placeholder="4.5" value="4.5"></td>
                        <td><input placeholder="5.1" value="5.1"></td>
                    </tr>
                    <tr>
                        <td><input placeholder="2024-11-10" value="2024-11-10"></td>
                        <td><input placeholder="Market Well" value="Market Well"></td>
                        <td><input placeholder="8.1" value="8.1"></td>
                        <td><input placeholder="8.0" value="8.0"></td>
                        <td><input placeholder="3.2" value="3.2"></td>
                    </tr>
                </tbody>
            </table>
        </div>
      </div>

      <!-- Chart Output Section -->
      <div class="bg-white p-4 sm:p-6 rounded-lg shadow-lg">
        <h2 class="text-2xl font-semibold text-gray-800 mb-6">Visualizations</h2>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          
          <!-- pH Bar Chart -->
          <div class="border p-4 rounded-lg shadow-inner bg-gray-50">
            <h3 class="text-xl font-semibold text-blue-700 mb-2">pH Bar Chart (Acidity)</h3>
            <div id="phChart" class="chart-box"></div>
          </div>

          <!-- Turbidity Bar Chart -->
          <div class="border p-4 rounded-lg shadow-inner bg-gray-50">
            <h3 class="text-xl font-semibold text-green-700 mb-2">Turbidity Bar Chart (Clarity)</h3>
            <div id="turbidityChart" class="chart-box"></div>
          </div>

          <!-- DO Bar Chart (Full Width) -->
          <div class="border p-4 rounded-lg shadow-inner bg-gray-50 lg:col-span-2">
            <h3 class="text-xl font-semibold text-purple-700 mb-2">Dissolved Oxygen (DO) Bar Chart (Water Health)</h3>
            <div id="doChart" class="chart-box"></div>
          </div>

        </div>
      </div>
    </main>
  </div>

  <!-- ==== GEMINI MODAL ==== -->
  <div id="gemini-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
    <!-- ... (Modal ka content same hai, koi change nahi) ... -->
    <div class="bg-white rounded-lg shadow-2xl w-full max-w-2xl">
      <!-- Modal Header -->
      <div class="flex justify-between items-center border-b p-5">
        <h3 class="text-2xl font-semibold text-gray-900">âœ¨ AI Analysis & Suggestions</h3>
        <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
      </div>
      <!-- Modal Body -->
      <div id="modal-body" class="p-6 max-h-[60vh] overflow-y-auto">
        <!-- Loading Spinner -->
        <div id="modal-loader" class="flex flex-col items-center justify-center p-10">
          <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4"></div>
          <p class="text-gray-600 text-lg">AI aapke data ko analyze kar raha hai... Please wait...</p>
        </div>
        <!-- Result Content -->
        <div id="modal-result" classs="hidden">
          <pre id="gemini-response" class="bg-gray-50 p-4 rounded-lg text-gray-700 whitespace-pre-wrap" style="font-family: 'Inter', sans-serif; line-height: 1.6;"></pre>
        </div>
      </div>
      <!-- Modal Footer -->
      <div class="border-t p-4 bg-gray-50 rounded-b-lg text-right">
        <button onclick="closeModal()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-5 rounded-lg transition-colors">
          Close
        </button>
      </div>
    </div>
  </div>

<script>
// Chart instances ko store karne ke liye global variables
let phChart, turbidityChart, doChart;
// const sidebar = document.getElementById('sidebar'); // REMOVED
// const overlay = document.getElementById('overlay'); // REMOVED

// Window load hone par charts ko initialize karna
window.onload = function() {
  // Chart instances ko create karna
  phChart = echarts.init(document.getElementById("phChart"));
  turbidityChart = echarts.init(document.getElementById("turbidityChart"));
  doChart = echarts.init(document.getElementById("doChart"));

  // "Add Row" button ko event listener lagana
  document.getElementById("addRowBtn").addEventListener("click", addRow);

  // Page load par pehli baar charts generate karna (placeholder data ke sath)
  generateCharts();
  
  // Resize listener for charts
  window.addEventListener('resize', () => {
      phChart.resize();
      turbidityChart.resize();
      doChart.resize();
  });
};

// ==== RESPONSIVE SIDEBAR FUNCTION ====
// FUNCTION REMOVED

// Table mein nayi row add karne ka function
function addRow() {
  // ... existing addRow function ...
  const tbody = document.getElementById("masterTbody");
  const newRow = document.createElement("tr");
  newRow.innerHTML = `
    <td><input placeholder="..."></td>
    <td><input placeholder="..."></td>
    <td><input placeholder="..."></td>
    <td><input placeholder="..."></td>
    <td><input placeholder="..."></td>
  `;
  tbody.appendChild(newRow);
}

// ---- SMART FUNCTIONS (Yeh standards check karte hain) ----

// 1. pH ke liye color aur status function
function getPhVisuals(pH) {
  // ... existing getPhVisuals function ...
  let color;
  let status;
  if (pH >= 0 && pH < 6.5) {
    color = '#ff6347'; // Reddish for Acidic
    status = 'ACIDIC';
  } else if (pH >= 6.5 && pH <= 7.5) {
    color = '#3cb371'; // Greenish for Neutral/Good
    status = 'NEUTRAL (GOOD)';
  } else if (pH > 7.5 && pH <= 14) {
    color = '#4169e1'; // Bluish for Alkaline
    status = 'ALKALINE';
  } else {
    color = '#cccccc'; // Grey for invalid/out of range
    status = 'UNKNOWN';
  }
  return { color, status };
}

// 2. Turbidity ke liye color aur status function
function getTurbidityVisuals(ntu) {
  // ... existing getTurbidityVisuals function ...
  let color;
  let status;
  // WHO standards for drinking water
  if (ntu >= 0 && ntu <= 1) {
    color = '#3cb371'; // Green
    status = 'EXCELLENT';
  } else if (ntu > 1 && ntu <= 5) {
    color = '#ffc107'; // Yellow
    status = 'FAIR';
  } else if (ntu > 5) {
    color = '#ff6347'; // Red
    status = 'UNSAFE';
  } else {
    color = '#cccccc';
    status = 'UNKNOWN';
  }
  return { color, status };
}

// 3. DO ke liye color aur status function
function getDoVisuals(DO) {
  // ... existing getDoVisuals function ...
  let color;
  let status;
  // Environmental standards for fish life
  if (DO >= 6) {
    color = '#3cb371'; // Green
    status = 'GOOD (Healthy)';
  } else if (DO >= 4 && DO < 6) {
    color = '#ffc107'; // Yellow
    status = 'FAIR (Stressed)';
  } else if (DO < 4) {
    color = '#ff6347'; // Red
    status = 'POOR (Polluted)';
  } else {
    color = '#cccccc';
    status = 'UNKNOWN';
  }
  return { color, status };
}

// 4. ==== NEW: ROW STYLE FUNCTION ====
// Yeh function poori row ka overall status decide karta hai
function getOverallRowStyle(phStatus, turbidityStatus, doStatus) {
    // Priority: Danger (Unsafe) > Pollution (Poor) > Perfect (Healthy) > Warning (Fair/Acidic/Alkaline)
    if (turbidityStatus === 'UNSAFE') {
        return { base: 'bg-red-50', border: 'border-l-4 border-red-400' }; // Danger
    }
    if (doStatus === 'POOR') {
        return { base: 'bg-yellow-50', border: 'border-l-4 border-yellow-400' }; // Pollution
    }
    if (phStatus === 'NEUTRAL (GOOD)' && turbidityStatus === 'EXCELLENT' && doStatus === 'GOOD (Healthy)') {
        return { base: 'bg-green-50', border: 'border-l-4 border-green-400' }; // Perfect
    }
    if (turbidityStatus === 'FAIR' || doStatus === 'FAIR (Stressed)' || phStatus === 'ACIDIC' || phStatus === 'ALKALINE') {
        return { base: 'bg-gray-50', border: 'border-l-4 border-gray-400' }; // Warning/Attention
    }
    return { base: 'bg-white', border: 'border-l-4 border-transparent' }; // Default
}


// ---- MAIN CHART GENERATION FUNCTION ----
function generateCharts() {
  
  // 1. Master table se saara data nikalna
  const rows = document.querySelectorAll("#masterTbody tr");
  let locations = [];
  let phValues = [];
  let turbidityValues = [];
  let doValues = [];

  // Stat counters - initialize
  let unsafeTurbidityCount = 0;
  let poorDoCount = 0;
  let healthyCount = 0;
  let totalSamples = 0;


  // Har row ke through loop karna
  for (let i = 0; i < rows.length; i++) {
    const tr = rows[i]; // Get the <tr> element
    const tds = tr.querySelectorAll("td input");
    const allTds = tr.querySelectorAll('td'); // Get all <td> elements

    // Pehle, saare cells ko default par reset karna
    allTds.forEach((td, index) => {
        td.className = 'bg-white'; // Reset background
        if (index === 0) {
            td.classList.add('border-l-4', 'border-transparent'); // Reset border
        }
    });

    const location = tds.length > 1 ? tds[1].value : '';
    const ph = tds.length > 2 ? parseFloat(tds[2].value) : NaN;
    const turbidity = tds.length > 3 ? parseFloat(tds[3].value) : NaN;
    const doVal = tds.length > 4 ? parseFloat(tds[4].value) : NaN;

    // Agar location hai, tabhi data ko arrays mein push karna
    if (location && !isNaN(ph) && !isNaN(turbidity) && !isNaN(doVal)) {
      locations.push(location);
      phValues.push(ph);
      turbidityValues.push(turbidity);
      doValues.push(doVal);

      // Stats ko update karna
      totalSamples++;
      
      const phStatus = getPhVisuals(ph).status;
      const turbidityStatus = getTurbidityVisuals(turbidity).status;
      const doStatus = getDoVisuals(doVal).status;

      // ==== NEW: APPLY ROW STYLE ====
      // Row ka overall style get karna
      const style = getOverallRowStyle(phStatus, turbidityStatus, doStatus);
      
      // Saare <td> cells par style apply karna
      allTds.forEach((td, index) => {
          td.className = ''; // Reset class list
          style.base.split(' ').forEach(cls => td.classList.add(cls));
          if (index === 0) {
              style.border.split(' ').forEach(cls => td.classList.add(cls));
          }
      });
      // ==============================

      // Check for "Unsafe"
      if (turbidityStatus === 'UNSAFE') {
        unsafeTurbidityCount++;
      }
      // Check for "Poor"
      if (doStatus === 'POOR') {
        poorDoCount++;
      }
      // Check for "Healthy" (Strict)
      if (phStatus === 'NEUTRAL (GOOD)' && turbidityStatus === 'EXCELLENT' && doStatus === 'GOOD (Healthy)') {
        healthyCount++;
      }
    }
  }

  // ==== 1.5. KEY METRICS CARDS KO UPDATE KARNA ====
  document.getElementById('stat-total-samples').textContent = totalSamples;
  document.getElementById('stat-unsafe').textContent = unsafeTurbidityCount;
  document.getElementById('stat-poor-do').textContent = poorDoCount;
  document.getElementById('stat-good').textContent = healthyCount;


  // 2. pH Bar Chart (Smart)
  // ... existing phChart.setOption ...
  const phColors = phValues.map(value => getPhVisuals(value).color);
  const phStatuses = phValues.map(value => getPhVisuals(value).status);

  phChart.setOption({
    tooltip: { 
        trigger: 'axis',
        formatter: (params) => {
            let dataIndex = params[0].dataIndex;
            let value = phValues[dataIndex];
            let status = getPhVisuals(value).status;
            return `Location: ${locations[dataIndex]}<br/>` +
                   `pH Value: ${value}<br/>` +
                   `Status: <strong>${status}</strong>`;
        }
    },
    xAxis: { type: 'category', data: locations, name: 'Location' },
    yAxis: { type: 'value', name: 'pH Value' },
    series: [{
      data: phValues.map((value, index) => ({
          value: value,
          itemStyle: { color: phColors[index] },
          label: {
              show: true,
              position: 'top',
              formatter: (params) => phStatuses[params.dataIndex],
              color: '#333',
              fontWeight: 'bold'
          }
      })),
      type: 'bar',
      showBackground: true,
      backgroundStyle: { color: 'rgba(180, 180, 180, 0.2)' }
    }]
  });

  // 3. Turbidity Bar Chart (Smart)
  // ... existing turbidityChart.setOption ...
  const turbidityColors = turbidityValues.map(value => getTurbidityVisuals(value).color);
  const turbidityStatuses = turbidityValues.map(value => getTurbidityVisuals(value).status);

  turbidityChart.setOption({
    tooltip: { 
        trigger: 'axis',
        formatter: (params) => {
            let dataIndex = params[0].dataIndex;
            let value = turbidityValues[dataIndex];
            let status = getTurbidityVisuals(value).status;
            return `Location: ${locations[dataIndex]}<br/>` +
                   `Turbidity: ${value} NTU<br/>` +
                   `Status: <strong>${status}</strong>`;
        }
    },
    xAxis: { type: 'category', data: locations, name: 'Location' },
    yAxis: { type: 'value', name: 'Turbidity (NTU)' },
    series: [{
      data: turbidityValues.map((value, index) => ({
          value: value,
          itemStyle: { color: turbidityColors[index] },
          label: {
              show: true,
              position: 'top',
              formatter: (params) => turbidityStatuses[params.dataIndex],
              color: '#333',
              fontWeight: 'bold'
          }
      })),
      type: 'bar',
      showBackground: true,
      backgroundStyle: { color: 'rgba(180, 180, 180, 0.2)' }
    }]
  });

  // 4. DO Bar Chart (Smart)
  // ... existing doChart.setOption ...
  const doColors = doValues.map(value => getDoVisuals(value).color);
  const doStatuses = doValues.map(value => getDoVisuals(value).status);

  doChart.setOption({
    tooltip: { 
        trigger: 'axis',
        formatter: (params) => {
            let dataIndex = params[0].dataIndex;
            let value = doValues[dataIndex];
            let status = getDoVisuals(value).status;
            return `Location: ${locations[dataIndex]}<br/>` +
                   `DO: ${value} mg/L<br/>` +
                   `Status: <strong>${status}</strong>`;
        }
    },
    xAxis: { type: 'category', data: locations, name: 'Location' },
    yAxis: { type: 'value', name: 'DO (mg/L)' },
    series: [{
      data: doValues.map((value, index) => ({
          value: value,
          itemStyle: { color: doColors[index] },
          label: {
              show: true,
              position: 'top',
              formatter: (params) => doStatuses[params.dataIndex],
              color: '#333',
              fontWeight: 'bold'
          }
      })),
      type: 'bar',
      showBackground: true,
      backgroundStyle: { color: 'rgba(180, 180, 180, 0.2)' }
    }]
  });
}

// ==== GEMINI API FUNCTIONS ====

const modal = document.getElementById('gemini-modal');
const modalLoader = document.getElementById('modal-loader');
const modalResult = document.getElementById('modal-result');
const geminiResponseEl = document.getElementById('gemini-response');

// Modal ko close karna
function closeModal() {
  modal.classList.add('hidden');
}

// Data ko analyze karne ke liye main function
async function analyzeData() {
  // 1. Modal dikhana aur loader set karna
  modal.classList.remove('hidden');
  modalLoader.classList.remove('hidden');
  modalResult.classList.add('hidden');
  geminiResponseEl.textContent = '';

  // 2. Table se data collect karna
  let dataSummary = [];
  const rows = document.querySelectorAll("#masterTbody tr");

  for (let i = 0; i < rows.length; i++) {
    const tds = rows[i].querySelectorAll("td input");
    const location = tds[1].value;
    const ph = parseFloat(tds[2].value);
    const turbidity = parseFloat(tds[3].value);
    const doVal = parseFloat(tds[4].value);

    if (location && !isNaN(ph) && !isNaN(turbidity) && !isNaN(doVal)) {
      dataSummary.push(
        `Location: ${location} - pH: ${ph} (${getPhVisuals(ph).status}), Turbidity: ${turbidity} NTU (${getTurbidityVisuals(turbidity).status}), DO: ${doVal} mg/L (${getDoVisuals(doVal).status})`
      );
    }
  }

  if (dataSummary.length === 0) {
    geminiResponseEl.textContent = "Error: Please enter some valid data in the table first.";
    modalLoader.classList.add('hidden');
    modalResult.classList.remove('hidden');
    return;
  }

  // 3. Gemini ke liye Prompt banana
  const prompt = `
    Tum ek water quality expert (paani ki gunavatta ke visheshagya) ho.
    Mere paas Tirora, Gondia ke kuch areas ka water quality data hai.
    
    Mera Data:
    ${dataSummary.join('\n')}

    Please yeh kaam karo:
    1.  **Overall Summary:** Ek chhota paragraph (3-4 lines) mein poore data ki overall situation ko summarize karo. Aas paas ke logon ko dhyan mein rakh kar, aasan bhasha ka prayog karo.
    2.  **Actionable Suggestions:** Har us location ke liye jiska status 'FAIR', 'POOR', 'UNSAFE', 'ACIDIC', ya 'ALKALINE' hai, ek simple, actionable suggestion do (e.g., "Paani ko ubaal kar piye", "Local authorities ko inform karein", "Pipes check karwayein").
    3.  **Positive Points:** Jin locations ka status 'EXCELLENT' ya 'GOOD' hai, unki tareef karo.

    Response ko acche se format karna. Headings ke liye '*' ka use karna.
  `;

  // 4. Gemini API ko call karna
  try {
    const response = await callGeminiAPI(prompt);
    geminiResponseEl.textContent = response;
  } catch (error) {
    console.error(error);
    geminiResponseEl.textContent = `Error: Analysis fail ho gaya. Kya aap internet se connected hain?\n\n${error.message}`;
  }

  // 5. Result dikhana
  modalLoader.classList.add('hidden');
  modalResult.classList.remove('hidden');
}

// Gemini API call function with exponential backoff
async function callGeminiAPI(prompt) {
  const apiKey = ""; // API key ki zaroorat nahi hai
  const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
  
  const payload = {
    contents: [{ parts: [{ text: prompt }] }],
    // Grounding ke liye tools add kar sakte hain (optional)
    // tools: [{ "google_search": {} }],
  };

  let retries = 3;
  let delay = 1000; // 1 second

  while (retries > 0) {
    try {
      const response = await fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (!response.ok) {
        throw new Error(`API request failed with status ${response.status}`);
      }

      const result = await response.json();
      
      if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0].text) {
        return result.candidates[0].content.parts[0].text;
      } else {
        throw new Error("Invalid response structure from API.");
      }
    } catch (error) {
      console.warn(`API call failed, retrying... (${retries} retries left)`);
      retries--;
      if (retries === 0) {
        throw error;
      }
      await new Promise(resolve => setTimeout(resolve, delay));
      delay *= 2; // Exponential backoff
    }
  }
}
</script>

</body>
</html>